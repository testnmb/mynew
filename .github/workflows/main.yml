name: synczb

# è§¦å‘æ¡ä»¶
on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'main.py'
      - '.github/workflows/synczb.yml'

permissions:
  contents: write  # ç¡®ä¿ GITHUB_TOKEN å…·æœ‰å†™å…¥æƒé™

jobs:
  fetch_and_process:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºé¡¹ç›®ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    # 4. è¿è¡Œ Python è„šæœ¬
    - name: Run processing script
      run: |
        echo "å¼€å§‹æ‰§è¡ŒIPTVæºå¤„ç†..."
        python main.py

    # 5. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
    - name: Verify generated file
      run: |
        echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        if [ -f "my1.txt" ]; then
          echo "âœ… my1.txt æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < my1.txt) å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < my1.txt) è¡Œ"
          echo ""
          echo "=== æ–‡ä»¶å‰5è¡Œé¢„è§ˆ ==="
          head -5 my1.txt
        else
          echo "âŒ my1.txt æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi

    # 6. é…ç½® Git
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    # 7. æäº¤æ›´æ”¹
    - name: Commit and Push changes
      run: |
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å®é™…å†…å®¹
        if [ -f "my1.txt" ] && [ $(wc -c < my1.txt) -gt 0 ]; then
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ­£åœ¨æäº¤..."
          
          # æ·»åŠ æ–‡ä»¶
          git add my1.txt
          
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          
          # è·å–æ–‡ä»¶ä¿¡æ¯
          FILE_SIZE=$(wc -c < my1.txt | awk '{print $1}')
          FILE_LINES=$(wc -l < my1.txt | awk '{print $1}')
          URL_COUNT=$(grep -c "http" my1.txt || echo "0")
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          commit_msg="ğŸ“º è‡ªåŠ¨æ›´æ–°IPTVæºæ–‡ä»¶ [$CURRENT_TIME]
          
          æ›´æ–°IPTVç›´æ’­æºæ–‡ä»¶ï¼šmy1.txt
          - æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚
          - æ€»è¡Œæ•°: $FILE_LINES è¡Œ
          - åŒ…å«URL: $URL_COUNT ä¸ª
          
          ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ"
          
          # æäº¤
          git commit -m "$commit_msg" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          
          # æ¨é€åˆ°ä»“åº“
          git push origin main
          
          echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
        else
          echo "âš ï¸ æ–‡ä»¶ä¸ºç©ºæˆ–æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi

    # 8. ä¸Šä¼ å·¥ä»¶ï¼ˆå¯é€‰ï¼‰
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iptv-source
        path: my1.txt
        retention-days: 7
