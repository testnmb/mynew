name: synczb

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:
  push:
    paths:
      - 'main.py'
      - '.github/workflows/synczb.yml'

permissions:
  contents: write

jobs:
  sync-sources:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install requests
    
    - name: è¿è¡Œå¤„ç†è„šæœ¬
      run: |
        echo "å¼€å§‹åŒæ­¥ç›´æ’­æº..."
        python main.py
        
        echo ""
        echo "=== æ–‡ä»¶æ£€æŸ¥ ==="
        if [ -f "my1.txt" ]; then
          echo "âœ… my1.txt å·²ç”Ÿæˆ"
          echo "å¤§å°: $(wc -c < my1.txt) å­—èŠ‚"
          echo "è¡Œæ•°: $(wc -l < my1.txt) è¡Œ"
          echo "URLæ•°: $(grep -c "http" my1.txt || echo 0) ä¸ª"
        else
          echo "âŒ my1.txt æœªç”Ÿæˆ"
          # ç”Ÿæˆç©ºæ–‡ä»¶ç¡®ä¿æœ‰æ–‡ä»¶å¯æäº¤
          echo "smt,#genre#" > my1.txt
          echo "# åŒæ­¥å¤±è´¥ï¼Œç”Ÿæˆäº†ç©ºæ–‡ä»¶" >> my1.txt
        fi
    
    - name: é…ç½®Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: å¼ºåˆ¶æäº¤æ–‡ä»¶
      run: |
        echo "å¼ºåˆ¶æäº¤ my1.txt æ–‡ä»¶..."
        
        # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
        if [ ! -f "my1.txt" ]; then
          echo "smt,#genre#" > my1.txt
          echo "# è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶" >> my1.txt
        fi
        
        # å¼ºåˆ¶æ·»åŠ æ–‡ä»¶åˆ°Git
        git add -f my1.txt
        
        # è·å–æ–‡ä»¶ä¿¡æ¯
        FILE_SIZE=$(wc -c < my1.txt)
        FILE_LINES=$(wc -l < my1.txt)
        URL_COUNT=$(grep -c "http" my1.txt || echo 0)
        CURRENT_TIME=$(date +'%Y-%m-%d %H:%M')
        GIT_HASH=$(git log -1 --pretty=format:"%h")
        
        # æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ“º å¼ºåˆ¶æ›´æ–°ç›´æ’­æº [$CURRENT_TIME]

æ‰§è¡ŒçŠ¶æ€: æˆåŠŸ âœ…
Gitæäº¤: $GIT_HASH
æ–‡ä»¶ä¿¡æ¯:
- å¤§å°: $FILE_SIZE å­—èŠ‚
- è¡Œæ•°: $FILE_LINES è¡Œ
- é¢‘é“æ•°: $URL_COUNT ä¸ª

æœ¬æ¬¡æ‰§è¡Œå¼ºåˆ¶è¦†ç›–æ›´æ–°ï¼Œç¡®ä¿my1.txtä¸ºæœ€æ–°ç‰ˆæœ¬

ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ"

        # å¼ºåˆ¶æäº¤ï¼ˆä½¿ç”¨ --allow-empty ç¡®ä¿å³ä½¿æ²¡æœ‰å˜æ›´ä¹Ÿèƒ½æäº¤ï¼‰
        git commit --allow-empty -m "$COMMIT_MSG"
        
        # å¼ºåˆ¶æ¨é€åˆ°ä»“åº“
        git push origin main
        
        echo "âœ… å·²å¼ºåˆ¶æäº¤å¹¶è¦†ç›– my1.txt æ–‡ä»¶"
        
        # è¾“å‡ºæœ€ç»ˆçŠ¶æ€
        echo ""
        echo "=== æäº¤çŠ¶æ€ ==="
        echo "æäº¤æ—¶é—´: $CURRENT_TIME"
        echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
        echo "åŒ…å«é¢‘é“: $URL_COUNT ä¸ª"
    
    - name: ä¸Šä¼ æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: iptv-source
        path: my1.txt
        retention-days: 7
